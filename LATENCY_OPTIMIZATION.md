# å»¶è¿Ÿä¼˜åŒ–æŒ‡å—

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
é™ä½ä»æ‘„åƒå¤´æ•è·åˆ° LiveKit æ¨æµçš„ç«¯åˆ°ç«¯å»¶è¿Ÿ

## ğŸ“Š å»¶è¿Ÿæ¥æºåˆ†æ

### 1. Python å®¢æˆ·ç«¯å»¶è¿Ÿæº
- âŒ **æ—¶é—´æˆ³ç»˜åˆ¶**: `cv2.putText()` è°ƒç”¨
- âŒ **æ§åˆ¶ä¿¡æ¯å åŠ **: JSON è§£æå’Œæ–‡æœ¬ç»˜åˆ¶
- âŒ **å»¶è¿Ÿè®¡ç®—**: `time.time()` è°ƒç”¨å’Œæ•°å­¦è¿ç®—
- âŒ **é˜Ÿåˆ—ç¼“å†²**: å¤šçº§é˜Ÿåˆ—å¢åŠ å»¶è¿Ÿ
- âŒ **çº¿ç¨‹åˆ‡æ¢**: æ•è·â†’å¤„ç†â†’å‘å¸ƒçš„ä¸‰çº§æµæ°´çº¿

### 2. Rust å®¢æˆ·ç«¯å»¶è¿Ÿæº
- âŒ **æ•°æ®å¤åˆ¶**: `.to_vec()` å’Œ `copy_from_slice()`
- âŒ **JSON å¤„ç†**: æ§åˆ¶æ¶ˆæ¯çš„åºåˆ—åŒ–/ååºåˆ—åŒ–
- âŒ **çº¿ç¨‹é˜»å¡**: `push_i420_planes` é˜»å¡ä¸»å¾ªç¯

## âš¡ ä¼˜åŒ–æªæ–½

### Python å®¢æˆ·ç«¯ä¼˜åŒ–

#### æ ‡å‡†ä¼˜åŒ–ç‰ˆæœ¬ (`camera_publisher.py`) - å¹²å‡€è§†é¢‘ç”»é¢
```python
# å·²ç§»é™¤çš„æ“ä½œ:
- æ—¶é—´æˆ³ç»˜åˆ¶ (datetime.now().strftime)
- æ§åˆ¶ä¿¡æ¯å åŠ  (cv2.putText for control data)
- å»¶è¿Ÿè®¡ç®— (time.time() - timestamp)
- æ§åˆ¶æ¶ˆæ¯è®¢é˜… (å·²æ³¨é‡Šæ‰)
- æ‰€æœ‰ cv2.putText è°ƒç”¨
- æ‰€æœ‰æ–‡æœ¬å åŠ æ“ä½œ

# é»˜è®¤è®¾ç½®:
- debug_overlay = False (é»˜è®¤å…³é—­æ‰€æœ‰å åŠ )
- æä¾›çº¯å‡€çš„æ‘„åƒå¤´ç”»é¢
- ä»…ä¿ç•™å¿…è¦çš„é¢œè‰²è½¬æ¢
```

#### æœ€å°å»¶è¿Ÿç‰ˆæœ¬ (`camera_publisher_minimal.py`)
```python
# è¿›ä¸€æ­¥ä¼˜åŒ–:
- ç§»é™¤æ‰€æœ‰ cv2.putText è°ƒç”¨
- ç§»é™¤é˜Ÿåˆ—ç¼“å†² (ç›´æ¥å¤„ç†)
- ç§»é™¤æ§åˆ¶æ¶ˆæ¯å¤„ç†
- ç§»é™¤çº¿ç¨‹åˆ‡æ¢ (æ•è·å³å‘å¸ƒ)
- æœ€å°ç­‰å¾…æ—¶é—´ (0.001s)
```

### Rust å®¢æˆ·ç«¯ä¼˜åŒ–

#### æ•°æ®å¤åˆ¶ä¼˜åŒ–
```rust
// ä¼˜åŒ–å‰ (å¤šæ¬¡å¤åˆ¶)
let y = msg.data[0..y_size].to_vec();  // å¤åˆ¶1
let u = msg.data[y_size..y_size + uv_plane].to_vec();  // å¤åˆ¶2
let v = msg.data[y_size + uv_plane..expected].to_vec();  // å¤åˆ¶3

// ä¼˜åŒ–å (é›¶æ‹·è´)
let y = Arc::from(&msg.data[0..y_size]);  // é›¶æ‹·è´
let u = Arc::from(&msg.data[y_size..y_size + uv_plane]);  // é›¶æ‹·è´
let v = Arc::from(&msg.data[y_size + uv_plane..expected]);  // é›¶æ‹·è´
```

#### å¼‚æ­¥å¤„ç†ä¼˜åŒ–
```rust
// ä¼˜åŒ–å‰ (é˜»å¡ä¸»å¾ªç¯)
push_i420_planes(&y, &u, &v, width, height, ts_us).await

// ä¼˜åŒ–å (åå°å¤„ç†)
tokio::task::spawn_blocking(move || {
    // åœ¨é˜»å¡çº¿ç¨‹ä¸­å¤„ç†
    push_i420_planes(&y, &u, &v, width, height, ts_us)
});
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ ‡å‡†ä¼˜åŒ–æ¨¡å¼
```bash
# ä½¿ç”¨ä¼˜åŒ–åçš„æ ‡å‡†ç‰ˆæœ¬
./run.sh
```

### 2. æœ€å°å»¶è¿Ÿæ¨¡å¼
```bash
# ä½¿ç”¨æœ€å°å»¶è¿Ÿç‰ˆæœ¬
./run_minimal_latency.sh

# æˆ–è€…è®¾ç½®ç¯å¢ƒå˜é‡
MINIMAL_MODE=1 ./run.sh
```

### 3. ä»… Rust å®¢æˆ·ç«¯ï¼ˆæ—  Pythonï¼‰
```bash
# ä»…è¿è¡Œ Rust å®¢æˆ·ç«¯ï¼Œå‡è®¾å·²æœ‰è§†é¢‘æµ
./run_rust_only.sh
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | å»¶è¿Ÿæº | é¢„æœŸå»¶è¿Ÿå‡å°‘ |
|------|--------|-------------|
| åŸå§‹ç‰ˆæœ¬ | æ—¶é—´æˆ³+æ§åˆ¶+é˜Ÿåˆ— | åŸºå‡† |
| æ ‡å‡†ä¼˜åŒ– | ç§»é™¤æ—¶é—´æˆ³+æ§åˆ¶ | -50~100ms |
| æœ€å°å»¶è¿Ÿ | ç§»é™¤æ‰€æœ‰å åŠ +é˜Ÿåˆ— | -100~200ms |
| ä»… Rust | æ—  Python å¤„ç† | -200~300ms |

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. ç¡¬ä»¶ä¼˜åŒ–
- ä½¿ç”¨ USB 3.0 æ‘„åƒå¤´
- è®¾ç½®åˆé€‚çš„ FOURCC (MJPG/H264)
- è°ƒæ•´æ‘„åƒå¤´ç¼“å†²åŒºå¤§å°

### 2. ç³»ç»Ÿä¼˜åŒ–
```bash
# è®¾ç½®å®æ—¶ä¼˜å…ˆçº§
sudo nice -n -20 python3 camera_publisher_minimal.py

# è®¾ç½® CPU äº²å’Œæ€§
taskset -c 0,1 python3 camera_publisher_minimal.py
```

### 3. ç½‘ç»œä¼˜åŒ–
- ä½¿ç”¨æœ‰çº¿ç½‘ç»œè¿æ¥
- è°ƒæ•´ LiveKit ç ç‡è®¾ç½®
- å¯ç”¨ simulcast å¤šåˆ†è¾¨ç‡

### 4. ä»£ç ä¼˜åŒ–
- ä½¿ç”¨æ›´é«˜æ•ˆçš„å›¾åƒæ ¼å¼
- å®ç°å¸§ç‡è‡ªé€‚åº”
- æ·»åŠ å»¶è¿Ÿç›‘æ§

## ğŸ“Š ç›‘æ§å»¶è¿Ÿ

### Python ç«¯ç›‘æ§
```python
# åœ¨ camera_publisher_minimal.py ä¸­æ·»åŠ 
import time
start_time = time.time()
# ... å¤„ç†å¸§ ...
end_time = time.time()
latency_ms = (end_time - start_time) * 1000
print(f"å¤„ç†å»¶è¿Ÿ: {latency_ms:.2f}ms")
```

### Rust ç«¯ç›‘æ§
```rust
// åœ¨ main.rs ä¸­æ·»åŠ 
use std::time::Instant;
let start = Instant::now();
// ... å¤„ç†å¸§ ...
let duration = start.elapsed();
println!("å¤„ç†å»¶è¿Ÿ: {:?}", duration);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æœ€å°å»¶è¿Ÿæ¨¡å¼**ä¼šç§»é™¤æ‰€æœ‰è°ƒè¯•ä¿¡æ¯
2. **ä»… Rust æ¨¡å¼**éœ€è¦å¤–éƒ¨è§†é¢‘æº
3. **å®æ—¶ä¼˜å…ˆçº§**éœ€è¦ root æƒé™
4. **ç½‘ç»œå»¶è¿Ÿ**æ— æ³•é€šè¿‡ä»£ç ä¼˜åŒ–è§£å†³

## ğŸ¯ æ¨èé…ç½®

### ç”Ÿäº§ç¯å¢ƒï¼ˆæœ€ä½å»¶è¿Ÿï¼‰
```bash
# ä½¿ç”¨æœ€å°å»¶è¿Ÿæ¨¡å¼
./run_minimal_latency.sh
```

### å¼€å‘ç¯å¢ƒï¼ˆå¸¦è°ƒè¯•ï¼‰
```bash
# ä½¿ç”¨æ ‡å‡†ä¼˜åŒ–æ¨¡å¼
./run.sh
```

### æµ‹è¯•ç¯å¢ƒï¼ˆä»… Rustï¼‰
```bash
# ä½¿ç”¨ä»… Rust æ¨¡å¼
./run_rust_only.sh
```
