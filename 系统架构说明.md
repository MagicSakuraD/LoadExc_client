# LoadExc_client 系统架构说明

## 整体架构

### Python + Rust 混合模式（推荐）
```
┌─────────────────┐    ROS2话题    ┌─────────────────┐    LiveKit    ┌─────────────────┐
│                 │ ──────────────▶ │                 │ ─────────────▶ │                 │
│  Python客户端   │                │   Rust客户端    │               │  LiveKit Server │
│  (视频渲染)     │ ◀────────────── │  (LiveKit桥接)  │ ◀───────────── │  (远程控制)     │
│                 │   控制指令      │                 │   控制指令     │                 │
└─────────────────┘                └─────────────────┘               └─────────────────┘
        │                                   │
        │ 发布视频流                          │ 订阅视频流
        │ /camera_front_wide                │ 推送到LiveKit
        ▼                                   ▼
```

## 组件说明

### 1. Python客户端 (`python_client/`)
- **功能**: ROS2视频渲染，控制消息处理，视频流发布
- **发布话题**: `/camera_front_wide` (视频流)
- **订阅话题**: `/controls/teleop` (控制指令)
- **技术栈**: Python + OpenCV + ROS2

### 2. Rust客户端 (`src/main.rs`)
- **功能**: LiveKit桥接，WebRTC视频推流，控制指令转发
- **订阅话题**: `/camera_front_wide` (来自Python客户端)
- **发布话题**: `/controls/teleop` (发送给Python客户端)
- **LiveKit**: 视频推流 + 控制指令接收


## 数据流

### Python + Rust 混合模式
```
Python客户端 → ROS2话题 → Rust客户端 → LiveKit Server → 远程客户端
远程客户端 → LiveKit Server → Rust客户端 → ROS2话题 → Python客户端
```

## 启动方式

### Python + Rust 混合模式（推荐）
```bash
# 一键启动
./run.sh

# 手动启动
# 1. 启动 Python 客户端
cd python_client
python3 ros2_client.py &

# 2. 启动 Rust 客户端
cd ..
cargo run
```

## 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `LIVEKIT_URL` | `ws://192.168.3.41:7880` | LiveKit服务器地址 |
| `LIVEKIT_TOKEN_ENDPOINT` | 必须设置 | Token获取端点 |
| `ROS_IMAGE_TOPIC` | `/camera_front_wide` | 相机画面话题 |
| `ROS_CONTROL_TOPIC` | `/controls/teleop` | 控制指令话题 |
| `VIDEO_TRACK_NAME` | `ros_camera_feed` | LiveKit视频轨道名 |

## 控制指令格式

```json
{
  "type": "analog",
  "v": {
    "rotation": 0.0,    // 方向盘: -1 到 1
    "throttle": 0.0,     // 油门: 0 到 1
    "brake": 0.0,        // 刹车: 0 到 1
    "boom": 0.0,         // 大臂: -1 到 1
    "bucket": 0.0        // 铲斗: -1 到 1
  }
}
```

## 调试命令

### 查看ROS2话题
```bash
ros2 topic list
ros2 topic echo /camera_front_wide
ros2 topic echo /controls/teleop
```

### 手动发布控制指令
```bash
ros2 topic pub /controls/teleop std_msgs/String "data: '{\"type\":\"analog\",\"v\":{\"throttle\":0.5,\"rotation\":0.2}}'"
```

### 查看LiveKit连接
```bash
# 检查LiveKit服务器状态
curl http://192.168.3.41:7880/health
```

## 故障排除

### 1. Python客户端无法启动
- 检查Python依赖: `cd python_client && ./install.sh`
- 检查ROS2环境: `source /opt/ros/humble/setup.bash`
- 检查OpenCV: `python3 -c "import cv2"`

### 2. Rust客户端连接失败
- 检查LiveKit服务器: `curl http://192.168.3.41:7880/health`
- 检查Token端点: `curl http://192.168.3.41:3000/api/token`
- 检查WebRTC环境: `echo $LK_CUSTOM_WEBRTC`

### 3. ROS2话题通信失败
- 检查话题: `ros2 topic list`
- 检查环境变量: `echo $ROS_IMAGE_TOPIC`
- 运行连接测试: `python3 test_ros2_connection.py`

## 开发说明

### 添加新功能
1. **Python客户端**: 修改 `python_client/` 目录下的文件
2. **Rust客户端**: 修改 `src/main.rs` 或 `src/ros2_simple.rs`
3. **启动脚本**: 修改 `run.sh` 或 `run_python.sh`

### 日志级别
```bash
# Python客户端
RUST_LOG=debug python3 ros2_client.py

# Rust客户端
RUST_LOG=debug cargo run
```

### 性能优化
- **Python模式**: 调整OpenCV渲染参数，优化ROS2话题频率
- **混合模式**: 调整视频编码参数，优化WebRTC设置
- **原始模式**: 降低Bevy渲染质量，调整物理仿真频率

## 文件结构

```
LoadExc_client/
├── src/
│   ├── main.rs              # Rust LiveKit桥接程序
│   └── ros2_simple.rs       # 简化Rust ROS2客户端
├── python_client/            # Python客户端（推荐）
│   ├── ros2_client.py       # Python ROS2客户端
│   ├── video_renderer.py     # 视频渲染器
│   ├── control_message.py    # 控制消息处理
│   └── test_client.py        # 测试程序
├── run.sh                  # 多模式启动脚本
├── run_python.sh           # Python专用启动脚本
├── test_ros2_connection.py # ROS2连接测试器
└── 系统架构说明.md          # 本文档
```

## 推荐方案

### 🦀🐍 Python + Rust 混合模式（推荐）
- ✅ **开发速度快**: Python 部分几小时完成
- ✅ **维护成本低**: Python 代码简洁易懂
- ✅ **性能很好**: 结合两者优势
- ✅ **实车部署**: Rust 部分可直接部署到实车
- ✅ **测试友好**: Python 部分便于测试和调试

**结论**: 这是最适合你需求的方案！Python 用于测试阶段，Rust 用于实车部署。
